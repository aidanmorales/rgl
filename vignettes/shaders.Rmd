---
title: "Notes on Shaders"
author: "Duncan Murdoch"
date: "2023-05-20"
output:
  rmarkdown::html_vignette:
    fig_height: 5
    fig_width: 5
    toc: yes
  pdf_document:
    fig_height: 5
    fig_width: 5
    toc: yes
  html_document:
    default
vignette: >
  %\VignetteIndexEntry{Notes on Shaders}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include=FALSE}
if (!requireNamespace("rmarkdown", quietly = TRUE) ||
    !rmarkdown::pandoc_available("1.14")) {
  warning(call. = FALSE, "These vignettes assume rmarkdown and pandoc version 1.14.  These were not found. Older versions will not work.")
  knitr::knit_exit()
}
knitr::opts_chunk$set(echo = TRUE)
library(rgl)
options(rgl.useNULL = TRUE)
setupKnitr(autoprint = TRUE)
```

## Introduction

"Shaders" are programs written in GLSL that run on the GPU
to implement the details of rendering `rgl` scenes.  They were
introduced with OpenGL 2.0, and have been used in `rgl` for WebGL
rendering, and are now used in `rgl` when running within R
as well.

I have chosen to limit features to those present in OpenGL 2.1
for the following reasons:

 - This is the only "compatibility" version of OpenGL that is 
 supported on MacOS.  I want the compatibility version so that 
 older code is supported during the transition.
 - I'm hoping that most systems support 2.1, but haven't tested this
 yet.  If it turns out that all systems support it, I will 
 eventually drop the fixed pipeline.
 - OpenGL 2.1 uses GLSL 1.20.8, indicated as `#version 120` in the code.  WebGL 1 uses GLSL ES 1.00 which is similar.  It is indicated as
`#version 100` in the code.  The main difference is the use of
precision modifiers in GLSL ES.

## Steps in shader use in R

This section describes the steps in setting up and using shaders.

- Setting `flags`.
  - done by `Shape::getShaderFlags`.
  - callers:  `PrimitiveSet::initialize -> Shape::initShader -> Shape::getShaderFlags`, `SphereSet::initialize -> Shape::initShader -> Shape::getShaderFlags` and 
  `rgl::rgl_getShaderDefines` in the API.
- Compiling and linking the shaders.
  - done by `Shape::initShader`.
- Saving attribute and uniform locations.
  - done by `Shape::initShader` in several types.
- Creating the vertex and index buffers
  - done by `Shape::initShader`
- Putting attributes into the vertex buffer
  - done by `appendToBuffer` calls in various `initialize` methods.
- Putting indices into the index buffer
  - Not currently used. (FIXME:  delete it or use it where appropriate)
- Loading the vertex buffer data
  - done by `Shape::beginShader -> Shape::loadBuffers`
- Assigning values to the uniforms
  - done by `PrimitiveSet::drawBegin -> Shape::beginShader`
  - modified by `SphereSet::drawPrimitive` before each sphere.
- Enabling the attributes
  - done by `beginUse` in various array types, called from
    `drawBegin` in various types
- Setting state variables for material properties like 
  polygon offsets, etc.
  - done by `Material::beginUse`, from various `drawBegin` methods
  `BBoxDeco::render` and `Background::drawPrimitive`
- Do the drawing
  - done by `primitiveSet::drawAll`
  
  
  